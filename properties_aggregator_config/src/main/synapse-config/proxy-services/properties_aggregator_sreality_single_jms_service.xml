<?xml version="1.0" encoding="UTF-8"?>
<proxy name="properties_aggregator_sreality_single_jms_service" startOnLoad="true" transports="rabbitmq http https" xmlns="http://ws.apache.org/ns/synapse">
    <target>
        <inSequence>
            <property expression="$env/*[local-name()='Body']/*" name="url" scope="default" type="STRING"/>
            <dblookup>
                <connection>
                    <pool>
                        <dsName>jdbc/PropertyDatasource</dsName>
                    </pool>
                </connection>
                <statement>
                    <sql><![CDATA[SELECT CASE WHEN EXISTS (SELECT * FROM sreality WHERE url = ?) THEN CAST(1 AS INTEGER) ELSE CAST(0 AS INTEGER) END]]></sql>
                    <parameter expression="get-property('url')" type="VARCHAR"/>
                    <result column="case" name="isPropertyFound"/>
                </statement>
            </dblookup>
            <filter regex="0" source="get-property('isPropertyFound')">
                <then>
                    <script language="js"><![CDATA[var url = mc.getProperty("url");
                    	var id = url.substr(url.lastIndexOf("/") + 1);
                    	mc.setProperty("propertyId", id);]]></script>
                    <dbreport>
                        <connection>
                            <pool>
                                <dsName>jdbc/PropertyDatasource</dsName>
                            </pool>
                        </connection>
                        <statement>
                            <sql><![CDATA[INSERT INTO sreality (property_id, url) VALUES (?, ?)]]></sql>
                            <parameter expression="get-property('propertyId')" type="BIGINT"/>
                            <parameter expression="get-property('url')" type="VARCHAR"/>
                        </statement>
                    </dbreport>
                    <payloadFactory media-type="json">
                        <format>
                            {
                            	"channel": "C01224PS2CD",
                            	"text": "$1"
                            	
                            }
                        </format>
                        <args>
                            <arg evaluator="xml" expression="get-property('url')"/>
                        </args>
                    </payloadFactory>
                    <header name="Authorization" scope="transport" value="Bearer xoxp-1077708184100-1084165759505-1056857110807-16fa2a4254558bd0f575ddfef6fb1110"/>
                    <property name="HTTP_METHOD" scope="axis2" type="STRING" value="POST"/>
                    <send>
                        <endpoint>
                            <address uri="https://slack.com/api/chat.postMessage">
                                <suspendOnFailure>
                                    <initialDuration>-1</initialDuration>
                                    <progressionFactor>1</progressionFactor>
                                </suspendOnFailure>
                                <markForSuspension>
                                    <retriesBeforeSuspension>0</retriesBeforeSuspension>
                                </markForSuspension>
                            </address>
                        </endpoint>
                    </send>
                </then>
                <else/>
            </filter>
        </inSequence>
        <outSequence/>
        <faultSequence>
            <property name="SET_ROLLBACK_ONLY" scope="axis2" type="STRING" value="true"/>
        </faultSequence>
    </target>
    <parameter name="rabbitmq.connection.factory">AMQPConnectionFactory</parameter>
    <parameter name="rabbitmq.queue.name">sreality_property_single_queue</parameter>
</proxy>
